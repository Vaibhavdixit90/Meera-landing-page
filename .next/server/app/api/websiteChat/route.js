"use strict";(()=>{var e={};e.id=51,e.ids=[51],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},39491:e=>{e.exports=require("assert")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},57147:e=>{e.exports=require("fs")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},22037:e=>{e.exports=require("os")},71017:e=>{e.exports=require("path")},12781:e=>{e.exports=require("stream")},76224:e=>{e.exports=require("tty")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},78506:(e,t,s)=>{s.r(t),s.d(t,{originalPathname:()=>y,patchFetch:()=>q,requestAsyncStorage:()=>b,routeModule:()=>x,serverHooks:()=>D,staticGenerationAsyncStorage:()=>w});var a={};s.r(a),s.d(a,{GET:()=>g,POST:()=>f});var r=s(49303),o=s(88716),n=s(60670),i=s(87070),u=s(41482),l=s.n(u);let c=(e,t)=>{let s=e.headers.get("Authorization")||e.headers.get("authorization");if(!s)return{valid:!1,message:"No token provided"};let a=s.split(" ")[1];try{let e=l().verify(a,t);return{valid:!0,decoded:e}}catch(e){return{valid:!1,message:"Invalid token"}}};var p=s(29712);let d="0e641b7faad4611cef662526bd805434bef849f0d50a0248f1fb6c55ef756e374332ec1b5739293dd4413afa2d2569d96c1a723bfc1555b080253de663f4a242125e2b558ff264205a28ede838cc6f09bc9a35e266cbb924fa0f35c4791971c39b52933645bef31a20ddf3170156778d7059d79a7241515302669fe80b0af37c",m="b626ad85-8ca7-4157-a9c1-833234c670c0";if(!m)throw Error("NEXT_PUBLIC_JWT_SECRET is not defined. Please set it in your environment variables.");async function f(e){try{let t=c(e,m);if(!t.valid)return i.NextResponse.json({success:!1,message:t.message},{status:401});let{leadId:s,userQuery:a}=await e.json();console.log("\uD83D\uDE80 ~ POST ~ userQuery:",a),console.log("\uD83D\uDE80 ~ POST ~ leadId:",s);let r=await p.Z.get(`https://cms.flowautomate.io/api/leads/${s}?populate=conversation`,{headers:{Authorization:`Bearer ${d}`}});console.log("\uD83D\uDE80 ~ POST ~ leadResponse:",r.data),r.data.data.attributes.Summary;let o=r.data.data.attributes.conversation,n=o.filter(e=>"user"===e.from).length;if(10===n)return i.NextResponse.json({success:!1,message:"Conversation limit reached. Only 10 free conversation are allowed."},{status:200});console.log("in_final_conversation");let u=[...o],l=await h(u);l.push({role:"user",content:a}),console.log("conversationForLlm:",l);let f=await p.Z.post("https://api.fireworks.ai/inference/v1/chat/completions",{model:"accounts/fireworks/models/llama-v3p1-70b-instruct",max_tokens:16384,top_p:1,top_k:40,presence_penalty:0,frequency_penalty:0,temperature:0,messages:l},{headers:{Authorization:"Bearer fw_3ZnUMW4w6qathxBZ2kjQeqvV","Content-Type":"application/json"}});console.log("\uD83D\uDE80 ~ POST ~ llmResponse:",f.data),console.log("responseCheck_data",f.data.choices[0].message.content);let g=f.data.choices[0].message.content;console.log("\uD83D\uDE80 ~ POST ~ formattedLlmResponse:",g);let v=[{from:"user",message:a},{from:"assistant",message:g}];u=[...u,...v],console.log("\uD83D\uDE80 ~ POST ~ allConversation:",u);let x=await p.Z.put(`https://cms.flowautomate.io/api/leads/${s}`,{data:{conversation:u}},{headers:{Authorization:`Bearer ${d}`}});return console.log("\uD83D\uDE80 ~ POST ~ updateConversation:",x.data),i.NextResponse.json({success:!0,newConversation:v},{status:200})}catch(e){if(console.error("Error:",e),e instanceof Error)return i.NextResponse.json({success:!1,message:e.message},{status:500});return i.NextResponse.json({success:!1,message:"An unexpected error occurred"},{status:500})}}async function h(e){return await Promise.all(e.map(async({id:e,from:t,message:s,...a})=>({role:t,content:s,...a})))}async function g(e){try{let t=c(e,m);if(!t.valid)return i.NextResponse.json({success:!1,message:t.message},{status:401});let{searchParams:s}=new URL(e.url),a=s.get("leadId");if(!a)return i.NextResponse.json({success:!1,message:"leadId is required"},{status:400});let r=await p.Z.get(`https://cms.flowautomate.io/api/leads/${a}?populate=conversation`,{headers:{Authorization:`Bearer ${d}`}});console.log("\uD83D\uDE80 ~ GET ~ leadResponse:",r.data.data);let{conversation:o,...n}=r.data.data.attributes,u={...r.data.data,attributes:n},l=r.data.data.attributes.conversation,f=await v(l);return i.NextResponse.json({success:!0,data:u,conversation:f.filteredConversation,remainingChats:f.remainingChats},{status:200})}catch(e){return console.error("Error fetching conversation:",e),i.NextResponse.json({success:!1,message:"Error fetching conversation"},{status:500})}}async function v(e){let t=(await Promise.all(e.map(async e=>"system"!==e.from?e:null))).filter(e=>null!==e),s=t.filter(e=>"user"===e.from).length;return{filteredConversation:t,userMessageCount:s,remainingChats:Math.max(10-s,0)}}let x=new r.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/websiteChat/route",pathname:"/api/websiteChat",filename:"route",bundlePath:"app/api/websiteChat/route"},resolvedPagePath:"/Users/vaibhavdixit/Documents/meera-landing/app/api/websiteChat/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:b,staticGenerationAsyncStorage:w,serverHooks:D}=x,y="/api/websiteChat/route";function q(){return(0,n.patchFetch)({serverHooks:D,staticGenerationAsyncStorage:w})}}};var t=require("../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),a=t.X(0,[948,435,482],()=>s(78506));module.exports=a})();